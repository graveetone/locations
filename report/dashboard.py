import matplotlib.pyplot as plt
import streamlit as st
import pandas as pd

from utils.flows import compose_row
from utils.constants import (APP_ELAPSED_TIME_KEY, APPS_TITLES, IMAGE_PATH, SEED_PARAMS, REQUESTS_TITLES,
                             TABLE_HEADERS, APP_APDEX_KEY, APP_DB_SIZE_KEY,
                             APP_SUCCESS_KEY, TABLE_HEADERS_WITH_UNITS, APP_THROUGHTPUT_KEY)

st.set_page_config(page_title='Locations App Report',
                   page_icon="üìç",
                   layout="wide",
                   initial_sidebar_state="expanded"
                   )

#  side_bar_with_controls

st.sidebar.header("–ê–Ω–∞–ª—ñ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤")
st.sidebar.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏")

apps = st.sidebar.multiselect(
    label="–î–æ–¥–∞—Ç–∫–∏",
    options=APPS_TITLES,
    key="APPS"
)

seed_params = st.sidebar.multiselect(
    label='–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å—ñ–¥—É–≤–∞–Ω–Ω—è –±–∞–∑–∏',
    options=SEED_PARAMS,
    key="SEED_PARAMS"
)

requests = st.sidebar.multiselect(
    label='–í–µ–±—Å–æ–∫–µ—Ç–Ω—ñ –∑–∞–ø–∏—Ç–∏',
    options=REQUESTS_TITLES,
    key="REQUESTS",
    default=REQUESTS_TITLES
)
show_table = st.sidebar.toggle("–í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é")
show_interactive_plots = st.sidebar.toggle("–í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –¥–∏–Ω–∞–º—ñ—á–Ω—ñ –≥—Ä–∞—Ñ—ñ–∫–∏", value=False)

if all((apps, seed_params, requests)):
    all_apps_data = pd.DataFrame(columns=TABLE_HEADERS)

    plot_data = {"–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫": [param.locations_total for param in seed_params]}
    all_apps_data = {}   
    for app in apps:
        rows = [compose_row(app, param, requests=requests)
                for param in seed_params]
        current_app_data = pd.DataFrame(rows)
        all_apps_data[app] = current_app_data

        app_success_key = APP_SUCCESS_KEY.format(app=app)
        app_apdex_key = APP_APDEX_KEY.format(app=app)
        app_db_size_key = APP_DB_SIZE_KEY.format(app=app)
        app_elapsed_time_key = APP_ELAPSED_TIME_KEY.format(app=app)
        app_throughput_key = APP_THROUGHTPUT_KEY.format(app=app) 

        plot_data[app_success_key] = current_app_data["–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É—Å–ø—ñ—à–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤"]
        plot_data[app_apdex_key] = current_app_data["APDEX —ñ–Ω–¥–µ–∫—Å"]
        plot_data[app_db_size_key] = current_app_data["–†–æ–∑–º—ñ—Ä –±–∞–∑–∏"]
        plot_data[app_elapsed_time_key] = current_app_data["–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ"]
        plot_data[app_throughput_key] = current_app_data["–ü—Ä–æ–ø—É—Å–∫–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å"]
         

    if show_table:
        for app in apps:
            st.subheader(app)
            all_apps_data[app].columns = TABLE_HEADERS_WITH_UNITS
            st.table(all_apps_data[app])
    
    if show_interactive_plots:
        apps_success = [APP_SUCCESS_KEY.format(app=app) for app in apps]
        apps_apdex = [APP_APDEX_KEY.format(app=app) for app in apps]
        apps_db_size = [APP_DB_SIZE_KEY.format(app=app) for app in apps]
        apps_elapsed_time = [APP_ELAPSED_TIME_KEY.format(app=app) for app in apps]
        apps_throughput = [APP_THROUGHTPUT_KEY.format(app=app) for app in apps]

        plots_mapping = {
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —É—Å–ø—ñ—à–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": apps_success,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É APDEX –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": apps_apdex,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å —Ä–æ–∑–º—ñ—Ä—É –±–∞–∑–∏ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": apps_db_size,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —á–∞—Å—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": apps_elapsed_time,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω–æ—ó –∑–¥–∞—Ç–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": apps_throughput
        }

        for plot_title, ydata in plots_mapping.items():
            st.subheader(plot_title)
            st.line_chart(plot_data, x='–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫', y=ydata)        
    else:
        plots_mapping = {
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —É—Å–ø—ñ—à–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": app_success_key,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É APDEX –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": app_apdex_key,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å —Ä–æ–∑–º—ñ—Ä—É –±–∞–∑–∏ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": app_db_size_key,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —á–∞—Å—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": app_elapsed_time_key,
            "–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω–æ—ó –∑–¥–∞—Ç–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫": app_throughput_key
        }


        for plot_title, ydata_key in plots_mapping.items():
            fig, ax = plt.subplots()
            st.subheader(plot_title)
            ax.plot(plot_data['–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫'], plot_data[ydata_key], color='black')

            ax.scatter(plot_data['–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫'], plot_data[ydata_key], marker='s', color='black')
            
            st.pyplot(fig)
else:
    st.header('–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤')
    st.image(str(IMAGE_PATH), width=500)
